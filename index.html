<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>BetKing Міні-Додаток</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            padding: 0; /* Забираємо глобальний padding, будемо керувати ним для контенту */
            margin: 0;
            color: var(--tg-theme-text-color, #000000);
            background-color: var(--tg-theme-bg-color, #ffffff);
            overflow-x: hidden;
            display: flex; /* Для прикріплення футера або хедера */
            flex-direction: column;
            min-height: 100vh; /* Щоб контент займав весь екран */
        }
        .main-header { /* Новий стиль для хедера з балансами */
            padding: 10px 15px;
            background-color: var(--tg-theme-secondary-bg-color, #f0f0f0);
            border-bottom: 1px solid var(--tg-theme-hint-color, #cccccc);
            text-align: center; /* Поки що, можна змінити */
        }
        .balance-info p {
            margin: 2px 0;
            font-size: 12px;
            color: var(--tg-theme-text-color, #333333);
        }
        .balance-info strong {
            color: var(--tg-theme-link-color, #007bff); /* Виділення суми балансу */
        }

        nav {
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            background-color: var(--tg-theme-secondary-bg-color, #e9ecef);
            border-bottom: 1px solid var(--tg-theme-hint-color, #cccccc);
        }
        nav button {
            flex-grow: 1;
            padding: 10px 5px;
            font-size: 14px; /* Трохи менший шрифт для навігації */
            color: var(--tg-theme-button-text-color, #ffffff);
            background-color: var(--tg-theme-button-color, #007bff);
            border: none;
            border-radius: 0; /* Можна зробити їх без радіусу для вигляду вкладок */
            cursor: pointer;
            margin: 0 2px;
            opacity: 0.7;
        }
        nav button.active {
            opacity: 1;
            background-color: var(--tg-theme-link-color, #0056b3); /* Колір активної вкладки */
            /* Можна додати нижнє підкреслення або інший індикатор */
            border-bottom: 3px solid var(--tg-theme-button-text-color, #FFE433);
        }

        .page-content {
            padding: 15px; /* Padding тепер тут, для кожної сторінки */
            flex-grow: 1; /* Щоб контент займав доступне місце */
        }
        .page {
            display: none; /* Всі сторінки спочатку приховані */
        }
        .page.active {
            display: block; /* Активна сторінка видима */
        }

        /* Решта стилів, як були, з невеликими адаптаціями */
        .container { /* Цей клас тепер не потрібен як глобальний обгортковий */
            text-align: center;
        }
        h1, h2 { /* h1 тепер буде для заголовка сторінки, якщо потрібно */
            color: var(--tg-theme-text-color, #000000);
        }
        h1 { font-size: 24px; margin-bottom: 10px; }
        h2 { font-size: 20px; margin-top: 25px; margin-bottom: 15px; }
        p { font-size: 16px; margin-bottom: 10px; }

        button, .odds-button, .stake-button, .action-button, .prediction-button {
            padding: 10px 15px; font-size: 16px;
            color: var(--tg-theme-button-text-color, #ffffff);
            background-color: var(--tg-theme-button-color, #007bff);
            border: none; border-radius: 8px; cursor: pointer;
            margin: 5px; min-width: 80px;
        }
        .odds-button.selected, .prediction-button.selected {
            background-color: #FFE433; color: #000000;
        }
        .prediction-button:disabled {
            background-color: var(--tg-theme-hint-color, #cccccc); cursor: not-allowed;
        }
        .stake-options, .bet-confirmation, .prediction-result {
            margin-top: 15px; min-height: 40px;
        }
        .hidden { display: none; }

        #userInfo { /* Переміщено в кінець сторінки, може бути спільним футером */
            padding: 15px;
            text-align: center;
            font-size: 12px;
            color: var(--tg-theme-hint-color, #999999);
            word-break: break-all;
            border-top: 1px solid var(--tg-theme-hint-color, #cccccc);
        }
        .section-block {
            padding: 10px; border: 1px solid var(--tg-theme-hint-color, #dddddd);
            border-radius: 8px; margin-bottom: 15px;
            background-color: var(--tg-theme-secondary-bg-color, #f8f8f8);
        }
        .teams, .express-title, .daily-match-title {
            font-size: 18px; font-weight: bold; margin-bottom: 5px;
        }
        .match-date, .express-total-odds, .streak-info, .rewards-info {
            font-size: 14px; color: var(--tg-theme-hint-color, #777777); margin-bottom: 10px;
        }
        .rewards-info { font-style: italic; }
        .odds-container, .prediction-options {
            display: flex; justify-content: space-around; align-items: center; margin-bottom:10px;
        }
        .express-selections {
            list-style: none; padding-left: 0; text-align: left; font-size: 14px;
        }
        .express-selections li {
            padding: 5px 0; border-bottom: 1px dashed var(--tg-theme-hint-color, #eeeeee);
        }
        .express-selections li:last-child { border-bottom: none; }
        
        /* Стиль для покращеного повідомлення про зроблену ставку/прогноз */
        .info-message {
            padding: 10px;
            margin-top: 15px;
            border-radius: 5px;
            font-size: 14px;
            border: 1px solid transparent;
        }
        .info-message.success {
            background-color: var(--tg-theme-secondary-bg-color, #e6ffed); /* Світло-зелений */
            border-color: var(--tg-theme-button-color, #58cc02); /* Зелений */
            color: var(--tg-theme-text-color, #228B22); /* Темно-зелений текст */
        }
        .info-message.notice {
            background-color: var(--tg-theme-secondary-bg-color, #fff3cd); /* Світло-жовтий */
            border-color: var(--tg-theme-button-color, #ffeeba); /* Жовтий */
            color: var(--tg-theme-text-color, #856404); /* Темно-жовтий текст */
        }

    </style>
</head>
<body>
    <header class="main-header">
        <div class="balance-info">
            <p>Баланс: <strong id="mainBalanceDisplay">1500.00</strong> грн</p>
            <p>Бонуси: <strong id="bonusBalanceDisplay">250.50</strong> грн</p>
            <p>Фрібети: <strong id="freebetsDisplay">3</strong> шт.</p>
        </div>
    </header>

    <nav>
        <button data-page="pageMatchOfTheDay" class="nav-button active">Матч дня</button>
        <button data-page="pageExpressOfTheDay" class="nav-button">Експрес дня</button>
        <button data-page="pageDailyLogin" class="nav-button">Щоденний Прогноз</button>
    </nav>

    <div class="page-content">
        <div id="pageMatchOfTheDay" class="page active">
            <div id="matchOfTheDaySection" class="container">
                <h2>Матч дня</h2>
                <div class="section-block">
                    <div id="matchTeams" class="teams"></div>
                    <div id="matchDate" class="match-date"></div>
                    <div id="oddsContainer" class="odds-container"></div>
                </div>
                <div id="motdStakeOptions" class="stake-options hidden">
                    <p>Оберіть суму ставки для Матчу дня:</p>
                    <button class="stake-button motd-stake" data-amount="100">100 грн</button>
                    <button class="stake-button motd-stake" data-amount="200">200 грн</button>
                    <button class="stake-button motd-stake" data-amount="500">500 грн</button>
                </div>
                <div id="motdBetConfirmation" class="bet-confirmation"></div>
            </div>
        </div>

        <div id="pageExpressOfTheDay" class="page">
            <div id="expressOfTheDaySection" class="container">
                <h2>Експрес дня</h2>
                <div class="section-block">
                    <div id="expressTitle" class="express-title"></div>
                    <ul id="expressSelections" class="express-selections"></ul>
                    <div id="expressTotalOdds" class="express-total-odds"></div>
                    <button id="acceptExpressButton" class="action-button">Поставити на цей Експрес</button>
                </div>
                <div id="eotdStakeOptions" class="stake-options hidden">
                    <p>Оберіть суму ставки для Експресу дня:</p>
                    <button class="stake-button eotd-stake" data-amount="100">100 грн</button>
                    <button class="stake-button eotd-stake" data-amount="200">200 грн</button>
                    <button class="stake-button eotd-stake" data-amount="500">500 грн</button>
                </div>
                <div id="eotdBetConfirmation" class="bet-confirmation"></div>
            </div>
        </div>

        <div id="pageDailyLogin" class="page">
            <div id="dailyLoginSection" class="container">
                <h2>Щоденний Прогноз</h2>
                <div class="section-block">
                    <p class="streak-info">Ваша поточна серія перемог: <span id="currentStreak">0</span></p>
                    <p class="rewards-info">Нагороди: 3 дні - фрібет X, 7 днів - фрібет Y, 10 днів - фрібет Z.</p>
                    <div id="dailyMatchInfo">
                        <p class="daily-match-title">Матч на сьогодні: <span id="dailyMatchTeams"></span></p>
                        <div id="dailyPredictionOptions" class="prediction-options"></div>
                    </div>
                    <div id="dailyPredictionResult" class="prediction-result"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="userInfo"></div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        if (tg.themeParams.secondary_bg_color) {
            tg.setHeaderColor(tg.themeParams.secondary_bg_color); // Налаштовуємо колір хедера Telegram
        } else if (tg.themeParams.bg_color) {
             tg.setHeaderColor(tg.themeParams.bg_color);
        }

        // --- Навігація ---
        const navButtons = document.querySelectorAll('nav .nav-button');
        const pages = document.querySelectorAll('.page-content .page');

        function setActivePage(pageId) {
            pages.forEach(page => {
                page.classList.toggle('active', page.id === pageId);
            });
            navButtons.forEach(button => {
                button.classList.toggle('active', button.dataset.page === pageId);
            });
            // Зберігаємо активну сторінку, щоб повернутися до неї
            localStorage.setItem('betkingActivePage', pageId);
        }

        navButtons.forEach(button => {
            button.addEventListener('click', () => {
                setActivePage(button.dataset.page);
            });
        });
        
        // --- UTILITY FUNCTIONS ---
        function getFormattedDate(date) { /* ... (код без змін) ... */ }
        const TODAY_STRING = getFormattedDate(new Date());

        // --- Матч дня ---
        const matchOfTheDayData = { /* ... (код без змін) ... */ };
        let motdSelectedOdd = null;
        const matchTeamsEl = document.getElementById('matchTeams');
        const matchDateEl = document.getElementById('matchDate');
        const oddsContainerEl = document.getElementById('oddsContainer');
        const motdStakeOptionsEl = document.getElementById('motdStakeOptions');
        const motdBetConfirmationEl = document.getElementById('motdBetConfirmation');
        // ... (решта коду для Матчу дня, Експресу дня, Щоденного Прогнозу та UserInfo залишається такою ж, як у попередньому кроці)
        // Важливо: всі функції display...() мають викликатися після того, як DOM завантажено.
        // Ми перенесемо їх виклик після налаштування навігації.

        // --- Копіюємо логіку Матчу дня, як вона була в попередньому кроці ---
        matchOfTheDayData.team1 = "Динамо Київ";
        matchOfTheDayData.team2 = "Шахтар Донецьк";
        matchOfTheDayData.date = "12 Травня 2025, 19:00";
        matchOfTheDayData.odds = {
            p1: { name: "П1", value: 2.50, description: "Перемога Динамо Київ" },
            x:  { name: "X", value: 3.20, description: "Нічия" },
            p2: { name: "П2", value: 2.80, description: "Перемога Шахтар Донецьк" }
        };

        function displayMatchOfTheDay() {
            matchTeamsEl.textContent = `${matchOfTheDayData.team1} - ${matchOfTheDayData.team2}`;
            matchDateEl.textContent = matchOfTheDayData.date;
            oddsContainerEl.innerHTML = '';
            for (const key in matchOfTheDayData.odds) {
                const odd = matchOfTheDayData.odds[key];
                const button = document.createElement('button');
                button.className = 'odds-button';
                button.dataset.key = key;
                button.innerHTML = `${odd.name}<br>${odd.value.toFixed(2)}`;
                button.addEventListener('click', handleMotdOddSelection);
                oddsContainerEl.appendChild(button);
            }
        }
        function handleMotdOddSelection(event) {
            document.querySelectorAll('#oddsContainer .odds-button').forEach(btn => btn.classList.remove('selected'));
            const selectedButton = event.currentTarget;
            selectedButton.classList.add('selected');
            const oddKey = selectedButton.dataset.key;
            motdSelectedOdd = matchOfTheDayData.odds[oddKey];
            motdStakeOptionsEl.classList.remove('hidden');
            motdBetConfirmationEl.innerHTML = ''; // Використовуємо innerHTML для нових стилізованих повідомлень
        }
        document.querySelectorAll('.motd-stake').forEach(button => {
            button.addEventListener('click', function() {
                if (!motdSelectedOdd) {
                    tg.showAlert('Будь ласка, спочатку оберіть результат матчу дня!');
                    return;
                }
                const amount = parseInt(this.dataset.amount);
                const potentialWin = (amount * motdSelectedOdd.value).toFixed(2);
                // Використовуємо новий стиль для повідомлення
                const confirmationMessage = `Матч дня: Вашу ставку на "${motdSelectedOdd.description}" (${motdSelectedOdd.name} @${motdSelectedOdd.value.toFixed(2)}) на суму ${amount} грн прийнято (MVP).<br>Можливий виграш: ${potentialWin} грн.`;
                motdBetConfirmationEl.innerHTML = `<div class="info-message success">${confirmationMessage}</div>`;
                
                tg.HapticFeedback.notificationOccurred('success');
                if (typeof confetti === 'function') { confetti({ particleCount: 120, spread: 80, origin: { y: 0.6 } }); }
                motdStakeOptionsEl.classList.add('hidden');
                document.querySelectorAll('#oddsContainer .odds-button').forEach(btn => btn.classList.remove('selected'));
                motdSelectedOdd = null;
            });
        });


        // --- Експрес дня ---
        const expressOfTheDayData = { /* ... */ };
        const expressTitleEl = document.getElementById('expressTitle');
        const expressSelectionsEl = document.getElementById('expressSelections');
        const expressTotalOddsEl = document.getElementById('expressTotalOdds');
        const acceptExpressButton = document.getElementById('acceptExpressButton');
        const eotdStakeOptionsEl = document.getElementById('eotdStakeOptions');
        const eotdBetConfirmationEl = document.getElementById('eotdBetConfirmation');

        expressOfTheDayData.title = "Супер Експрес на Вихідні!";
        expressOfTheDayData.selections = [
            { description: "Манчестер Юнайтед - Перемога" },
            { description: "Барселона - ТБ 2.5" },
            { description: "Ювентус - Фора(0)" }
        ];
        expressOfTheDayData.totalOdds = 6.75;

        function displayExpressOfTheDay() {
            expressTitleEl.textContent = expressOfTheDayData.title;
            expressSelectionsEl.innerHTML = ''; 
            expressOfTheDayData.selections.forEach(selection => {
                const listItem = document.createElement('li');
                listItem.textContent = selection.description;
                expressSelectionsEl.appendChild(listItem);
            });
            expressTotalOddsEl.textContent = `Загальний коефіцієнт: ${expressOfTheDayData.totalOdds.toFixed(2)}`;
        }
        acceptExpressButton.addEventListener('click', function() {
            eotdStakeOptionsEl.classList.remove('hidden');
            eotdBetConfirmationEl.innerHTML = '';
        });
        document.querySelectorAll('.eotd-stake').forEach(button => {
            button.addEventListener('click', function() {
                const amount = parseInt(this.dataset.amount);
                const potentialWin = (amount * expressOfTheDayData.totalOdds).toFixed(2);
                const confirmationMessage = `Експрес дня: Вашу ставку з коеф. ${expressOfTheDayData.totalOdds.toFixed(2)} на суму ${amount} грн прийнято (MVP).<br>Можливий виграш: ${potentialWin} грн.`;
                eotdBetConfirmationEl.innerHTML = `<div class="info-message success">${confirmationMessage}</div>`;
                
                tg.HapticFeedback.notificationOccurred('success');
                if (typeof confetti === 'function') { confetti({ particleCount: 120, spread: 80, origin: { y: 0.6 }, zIndex: 9999 }); }
                eotdStakeOptionsEl.classList.add('hidden');
            });
        });

        // --- Щоденний Прогноз ---
        // Поки що залишаємо стару логіку, відкладений розрахунок буде наступним кроком
        const dailyMatchData = { /* ... */ };
        const dailyLoginState = { currentStreak: 0, lastPredictionDate: null };
        const currentStreakEl = document.getElementById('currentStreak');
        const dailyMatchTeamsEl = document.getElementById('dailyMatchTeams');
        const dailyPredictionOptionsEl = document.getElementById('dailyPredictionOptions');
        const dailyPredictionResultEl = document.getElementById('dailyPredictionResult');

        dailyMatchData.team1 = "Ворскла Полтава";
        dailyMatchData.team2 = "Зоря Луганськ";
        dailyMatchData.options = {
            p1: { name: "П1", description: "Перемога Ворскла" },
            x:  { name: "X", description: "Нічия" },
            p2: { name: "П2", description: "Перемога Зоря" }
        };
        dailyMatchData.correctOutcome = "p1";

        function loadDailyLoginState() { /* ... (код без змін) ... */ }
        function saveDailyLoginState() { /* ... (код без змін) ... */ }
        function displayDailyPredictionModule() { /* ... (код з невеликими змінами для стилізованих повідомлень) ... */ }
        function handleDailyPrediction(event) { /* ... (код з невеликими змінами для стилізованих повідомлень) ... */ }

        function getFormattedDate(date) { // Повторне визначення, якщо було вище
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function loadDailyLoginState() {
            const savedStreak = localStorage.getItem('betkingDailyStreak');
            const savedDate = localStorage.getItem('betkingLastPredictionDate');
            if (savedStreak !== null) dailyLoginState.currentStreak = parseInt(savedStreak, 10);
            if (savedDate !== null) dailyLoginState.lastPredictionDate = savedDate;
            if (dailyLoginState.lastPredictionDate && dailyLoginState.lastPredictionDate !== TODAY_STRING) {
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                if (dailyLoginState.lastPredictionDate !== getFormattedDate(yesterday)) {
                    dailyLoginState.currentStreak = 0;
                }
            }
            currentStreakEl.textContent = dailyLoginState.currentStreak;
        }
        function saveDailyLoginState() {
            localStorage.setItem('betkingDailyStreak', dailyLoginState.currentStreak);
            localStorage.setItem('betkingLastPredictionDate', dailyLoginState.lastPredictionDate);
        }
        function displayDailyPredictionModule() {
            loadDailyLoginState();
            currentStreakEl.textContent = dailyLoginState.currentStreak;
            dailyMatchTeamsEl.textContent = `${dailyMatchData.team1} - ${dailyMatchData.team2}`;
            dailyPredictionOptionsEl.innerHTML = '';
            let alreadyPredictedToday = dailyLoginState.lastPredictionDate === TODAY_STRING;

            for (const key in dailyMatchData.options) {
                const option = dailyMatchData.options[key];
                const button = document.createElement('button');
                button.className = 'prediction-button';
                button.dataset.key = key;
                button.textContent = option.name;
                button.title = option.description;
                if (alreadyPredictedToday) button.disabled = true;
                button.addEventListener('click', handleDailyPrediction);
                dailyPredictionOptionsEl.appendChild(button);
            }
            if (alreadyPredictedToday) {
                dailyPredictionResultEl.innerHTML = `<div class="info-message notice">Ви вже зробили свій прогноз на сьогодні. Повертайтесь завтра!</div>`;
            } else {
                dailyPredictionResultEl.innerHTML = `<div class="info-message notice">Зробіть свій прогноз на матч дня!</div>`;
            }
        }
        function handleDailyPrediction(event) {
            if (dailyLoginState.lastPredictionDate === TODAY_STRING) {
                tg.showAlert("Ви вже зробили прогноз на сьогодні!");
                return;
            }
            const predictedKey = event.currentTarget.dataset.key;
            const isCorrect = predictedKey === dailyMatchData.correctOutcome;
            let message = `Ваш прогноз: ${dailyMatchData.options[predictedKey].description}. `;
            let messageClass = 'notice';

            if (isCorrect) {
                message += "Це ПРАВИЛЬНО! ✅";
                messageClass = 'success';
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                if (dailyLoginState.lastPredictionDate === getFormattedDate(yesterday)) {
                    dailyLoginState.currentStreak++;
                } else {
                    dailyLoginState.currentStreak = 1;
                }
                tg.HapticFeedback.notificationOccurred('success');
                if (typeof confetti === 'function') { confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } }); }
            } else {
                message += "На жаль, НЕПРАВИЛЬНО. ❌";
                dailyLoginState.currentStreak = 0;
                tg.HapticFeedback.notificationOccurred('error');
            }
            dailyLoginState.lastPredictionDate = TODAY_STRING;
            saveDailyLoginState();
            currentStreakEl.textContent = dailyLoginState.currentStreak;
            
            const rewards = { 3: "Фрібет X", 7: "Фрібет Y", 10: "Фрібет Z" };
            if (isCorrect && rewards[dailyLoginState.currentStreak]) {
                message += `\n🎉 Вітаємо! Ви виграли ${rewards[dailyLoginState.currentStreak]} за ${dailyLoginState.currentStreak} правильних прогнозів поспіль!`;
            }
            dailyPredictionResultEl.innerHTML = `<div class="info-message ${messageClass}">${message.replace(/\n/g, "<br>")}</div>`;
            document.querySelectorAll('.prediction-button').forEach(btn => btn.disabled = true);
        }

        // --- Інформація про користувача ---
        const userInfoDiv = document.getElementById('userInfo');
        // ... (код для userInfoDiv без змін) ...
        if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
            const user = tg.initDataUnsafe.user;
            let userInfoText = `Користувач: ${user.first_name || ''} ${user.last_name || ''} (@${user.username || 'N/A'}, ID: ${user.id})`;
            userInfoDiv.innerHTML = userInfoText;
        } else {
            userInfoDiv.textContent = "Дані користувача Telegram недоступні.";
        }

        // --- Ініціалізація ---
        // Визначаємо, яку сторінку відкрити (з localStorage або першу за замовчуванням)
        const lastActivePage = localStorage.getItem('betkingActivePage') || 'pageMatchOfTheDay';
        setActivePage(lastActivePage);

        displayMatchOfTheDay();
        displayExpressOfTheDay();
        displayDailyPredictionModule();

    </script>
</body>
</html>